<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <script src="https://docs.opencv.org/3.4.0/opencv.js" type="text/javascript"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js" charset="utf-8"></script>
    <!--<script defer src="https://pyscript.net/latest/pyscript.js"></script>-->
    <!--<script type="module" src="vi.js"></script>-->
    <!--<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
      -->
  </head>
  <body>
    <h1 style="text-align: center">Find your bicycles in images, videos and livestreams!</h1>
    <div id="select" style="align-items:center">
        <h2>choose your type of media</h2>
        <button onclick="selectType('image')">image</button>
      </div>
      <button onclick="selectType('home')" id="home" style="display: none">home</button>
      <div id ="imagepredict" style="display: none">
        <img id="myimage" height="180" width="180">
        <input type="file" id="photo" name="photo" accept="image/*" onchange="predictImage(event)">
        <p id="imagePrediction"></p>
      </div>
  
  
        
      </div>
      <script>
        const model =  tf.loadGraphModel('');
        let mobilenet = undefined;
        loadMobileNetFeatureModel();
        predict = true;
        camEnabled=false;
        graphCreated=false;
        predictions=[]
      function selectType(el){
        if (el=="home"){
          document.getElementById("select").style.display="";
          document.getElementById("videopredict").style.display="none";
          document.getElementById("imagepredict").style.display="none";
          document.getElementById("live").style.display="none";
          document.getElementById("home").style.display="none";
        }else{
          document.getElementById("select").style.display="none";
          document.getElementById("home").style.display="";
          if (el=="video"){
            document.getElementById("videopredict").style.display="";
          }
          if (el=="image"){
            document.getElementById("imagepredict").style.display="";
  
          }
          if (el=="live"){
            document.getElementById("live").style.display="";
  
          }
        }
      }
      function predictImage(event){
        const image=document.getElementById("photo").files[0]
        image.src = URL.createObjectURL(event.target.files[0])
        var selectedFile = event.target.files[0];
        var reader = new FileReader();
  
        var imgtag = document.getElementById("myimage");
        imgtag.title = selectedFile.name;
        reader.onload = function(event) {
          imgtag.src = event.target.result;
        };
        
        reader.readAsDataURL(selectedFile);
        console.log(selectedFile)
        model.then(function (res) {
      const example = tf.cast(tf.browser.fromPixels(imgtag),'float32');
      const prediction = res.predict(example.reshape([-1,180,180,3])).squeeze();
      console.log("prediction: "+prediction);
      let highestIndex = prediction.argMax().arraySync()
      document.getElementById("imagePrediction").innerText="This image is"+ (highestIndex==0?" ":" not ") + "a bike!"
      console.log(highestIndex)
  }, function (err) {
      console.log(err);
  });
  
      }
        function predictButton(){
          predict=true;
          predictLoop();
        }
        async function predictLoop() {
          if (!camEnabled){
            alert("Please Enable Camera To Start Predicting")
          }
          else{
            tf.tidy(function() {
              //console.log(200)
              let videoFrameAsTensor = tf.browser.fromPixels(VIDEO);
              let resizedTensorFrame = tf.image.resizeBilinear(videoFrameAsTensor,[MOBILE_NET_INPUT_HEIGHT, 
                  MOBILE_NET_INPUT_WIDTH], true);
              let imageFeatures = mobilenet.predict(resizedTensorFrame.expandDims());
              let predictionArray=imageFeatures.arraySync()[0];
              let highestIndex=Math.max(imageFeatures.arraySync()[0]);
              className=""
              if (predictionArray[1]>0){
                className=CLASS_NAMES[1]
              } else{
                className=CLASS_NAMES[0]
                times.push(new Date())
              }
              STATUS.innerText = 'Prediction: ' + className + ' with ' + Math.floor(Math.abs(predictionArray[1])/(Math.abs(predictionArray[0])+Math.abs(predictionArray[1])) * 100) + '% confidence';
            });
            if(predict){
              window.requestAnimationFrame(predictLoop);
            }
          }
        }
        async function loadMobileNetFeatureModel() {
    const URL='model/model.json';
    mobilenet = await tf.loadGraphModel(URL, {fromTFHub: false});
    STATUS.innerText = 'Model loaded successfully!';
  }
    let modelLive = tf.sequential();
  modelLive.add(tf.layers.dense({inputShape: [1024], units: 128, activation: 'relu'}));
  modelLive.add(tf.layers.dense({units: CLASS_NAMES.length, activation: 'softmax'}));
  
  modelLive.summary();
  function reset(){
    predict = false;
    cleanedTimesString="";
    start=times[0]
    for(i = 1; i<times.length; i++){
      if((times[i].getSeconds()-times[i-1].getSeconds()>1)){
        cleanedTimesString+= start.getHours()+":"+start.getMinutes()+":"+start.getSeconds()+" and "+times[i-1].getHours()+":"+times[i-1].getMinutes()+":"+times[i-1].getSeconds()+"; "
        start=times[i]
      } else if (i==times.length-1){
        cleanedTimesString+=start.getHours()+":"+start.getMinutes()+":"+start.getSeconds()+" and "+times[i].getHours()+":"+times[i].getMinutes()+":"+times[i].getSeconds()
      }
    }
  
    alert("Bikes appeared between " + cleanedTimesString);
  
  }
  function showGraph(){
    if (graphCreated){
      xKeys=Array.from({ length: predictions.length }, (_, i) => i/25)
      yKeys=Array.from({ length: predictions.length }, (_, i) => predictions[i][0][0]-predictions[i][0][1])
      Plotly.newPlot(document.getElementById("graph"),[{x:xKeys,y:yKeys}],{margin: {t: 0}});
      document.getElementById("graph").style.display="block"
    }else{
      alert("please select a video to view graph");
    }
  }
  
      </script>
      
      <script type="css">
        body {
    font-family: helvetica, arial, sans-serif;
    margin: 2em;
  }
  
  h1 {
    font-style: italic;
    color: #FF6F00;
  }
  
  
  video {
    clear: both;
    display: block;
    margin: 10px;
    background: #000000;
    width: 640px;
    height: 480px;
  }
  
  button {
    padding: 10px;
    float: left;
    margin: 5px 3px 5px 10px;
  }
  
  .removed {
    display: none;
  }
  
  #status {
    font-size:150%;
  }
  div{
    width=100%;
    align-items:'center';
  }
  
      </script>
      
    </body>
</html>